generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}


enum Roles{
  STUDENT
  TUTOR
  ADMIN
}


enum AuthProvider {
  CREDENTIALS
  GOOGLE
  APPLE
}

model User {
  id                      String                    @id @default(auto()) @map("_id") @db.ObjectId
  name                    String?
  email                   String                    @unique
  phone                   String?                   @unique
  password                String?
  avatar                  String?
  role                    Roles                     @default(STUDENT)

  provider                AuthProvider              @default(CREDENTIALS)

  isEmailVerified         Boolean                   @default(false)
  isPhoneVerified         Boolean                   @default(false)

  hashedRefreshToken      String?
  refreshTokenExpiresAt   DateTime?

  student                 Student?
  tutor                   Tutor?


  createdAt               DateTime                  @default(now())
  updatedAt               DateTime                  @updatedAt
}

model Student{
  id                      String                    @id @default(auto()) @map("_id") @db.ObjectId

  user                    User                      @relation(fields: [userId], references: [id])
  userId                  String                    @unique @db.ObjectId

  classGrade              String?
  board                   String?
  stream                  String?

  createdAt               DateTime                  @default(now())
  updatedAt               DateTime                  @updatedAt

  tasks                   Task[]
  enrollments             ClassEnrollment[]
  attendances             Attendance[]
}

enum TutorStatus {
  NOT_APPLIED      // just signed up as tutor but hasn't filled form yet
  PENDING_REVIEW   // form submitted, waiting for admin
  APPROVED         // verified tutor
  REJECTED         // rejected, can re-apply
  SUSPENDED        // blocked by admin
}


model Tutor{
  id                      String                    @id @default(auto()) @map("_id") @db.ObjectId

  user                    User                      @relation(fields: [userId], references: [id])
  userId                  String                    @unique @db.ObjectId

  shortTitle              String?
  subjects                String[]
  levels                  String[]
  yearsOfExp              Int?
  bio                     String?
  qualification           String?
  links                   String[]
  isVerified              Boolean                   @default(false)
  tutorStatus             TutorStatus               @default(NOT_APPLIED)

  createdAt               DateTime                  @default(now())
  updatedAt               DateTime                  @updatedAt

  verificationRequests    TutorVerificationRequest[]
  classes                 TuitionClass[]
}


enum VerificationStatus {
  PENDING
  APPROVED
  REJECTED
}

model TutorVerificationRequest {
  id                          String                    @id @default(auto()) @map("_id") @db.ObjectId
  tutorId                     String                    @db.ObjectId
  tutor                       Tutor                     @relation(fields: [tutorId], references: [id])
  status                      VerificationStatus        @default(PENDING)
  adminId                     String?                   @db.ObjectId
  adminNote                   String?
  documents                   String[]
  createdAt                   DateTime                  @default(now())
  updatedAt                   DateTime                  @updatedAt
}


enum Status {
  ACTIVE
  INACTIVE
  ARCHIVED
}


model Subject{
  id                      String                    @id @default(auto()) @map("_id") @db.ObjectId

  name                    String
  slug                    String                    @unique
  icon                    String?
  priority                Int                       @unique
  status                  Status                    @default(ACTIVE)

  createdAt               DateTime                  @default(now())
  updatedAt               DateTime                  @updatedAt

  @@index([status])
  classes                 TuitionClass[]
}


model Level{
  id                      String                    @id @default(auto()) @map("_id") @db.ObjectId

  name                    String
  slug                    String                    @unique
  icon                    String?
  priority                Int                       @unique
  status                  Status                    @default(ACTIVE)

  createdAt               DateTime                  @default(now())
  updatedAt               DateTime                  @updatedAt

  @@index([status])
  classes                 TuitionClass[]

}


model Board{
  id                      String                    @id @default(auto()) @map("_id") @db.ObjectId

  name                    String
  slug                    String                    @unique
  icon                    String?
  priority                Int                       @unique
  status                  Status                    @default(ACTIVE)

  createdAt               DateTime                  @default(now())
  updatedAt               DateTime                  @updatedAt

  @@index([status])
  classes                 TuitionClass[]

}


model Language{
  id                      String                    @id @default(auto()) @map("_id") @db.ObjectId

  name                    String
  slug                    String                    @unique
  icon                    String?
  priority                Int                       @unique
  status                  Status                    @default(ACTIVE)

  createdAt               DateTime                  @default(now())
  updatedAt               DateTime                  @updatedAt

  @@index([status])
  classes                 TuitionClass[]
}




//Task System
enum TaskType{
  PRIVATE
  ASSIGNED
}

enum TaskStatus{
  TODO
  ONGOING
  COMPLETED
}

enum TaskCommentType{
  HELP_REQUEST
  TUTOR_REPLY
  TUTOR_REMARK
  TUTOR_FEEDBACK
}

model ClassTask {
  id                      String                    @id @default(auto()) @map("_id") @db.ObjectId

  classId                 String                    @db.ObjectId
  tutorId                 String                    @db.ObjectId

  title                   String
  description             String?
  
  dueDate                 DateTime?

  createdAt               DateTime                  @default(now())
  updatedAt               DateTime                  @updatedAt

  tasks                   Task[]                    @relation("ClassTaskToStudentTasks")

  @@index([classId])
  @@index([tutorId])
}


model Task{
  id                      String                    @id @default(auto()) @map("_id") @db.ObjectId

  studentId               String                    @db.ObjectId
  student                 Student                   @relation(fields: [studentId], references: [id])

  title                   String
  description             String?

  dueDate                 DateTime?

  type                    TaskType                  @default(PRIVATE)
  status                  TaskStatus                @default(TODO)

  // Only for CLASS_ASSIGNED tasks
  classTaskId             String?                   @db.ObjectId
  classTask               ClassTask?                @relation("ClassTaskToStudentTasks",fields: [classTaskId],references: [id])

  classId                 String?                   @db.ObjectId
  tutorId                 String?                   @db.ObjectId

  // Indicates tutor override (rejected proof)
  overriddenByTutor       Boolean                   @default(false)

  createdAt               DateTime                  @default(now())
  updatedAt               DateTime                  @updatedAt

  proofs                  TaskProof[]
  comments                TaskComment[]

  @@index([studentId])
  @@index([classTaskId])
  @@index([classId])
  @@index([tutorId])
  @@index([status])
  @@index([type])
  @@index([studentId, status]) // dashboard filters
}


model TaskProof {
  id                      String                      @id @default(auto()) @map("_id") @db.ObjectId

  taskId                  String                      @db.ObjectId
  task                    Task                        @relation(fields: [taskId], references: [id])

  studentId               String                      @db.ObjectId

  fileUrl                 String
  note                    String?

  createdAt               DateTime                    @default(now())

  @@index([taskId])
}


model TaskComment {
  id                      String                      @id @default(auto()) @map("_id") @db.ObjectId

  taskId                  String                      @db.ObjectId
  task                    Task                        @relation(fields: [taskId], references: [id])

  authorId                String                      @db.ObjectId

  type                    TaskCommentType
  message                 String

  createdAt               DateTime                    @default(now())

  @@index([taskId])
  @@index([type])
}



// Tuition Class Functionality
enum ClassType {
  GROUP
  PRIVATE
}

enum ClassVisibility {
  PUBLIC
  PRIVATE
}

enum ClassStatus{
  DRAFT
  PUBLISHED
  ACTIVE
  COMPLETED
  ARCHIVED
}

enum DayOfWeek {
  MON
  TUE
  WED
  THU
  FRI
  SAT
  SUN
}

model TuitionClass{
  id                      String                      @id @default(auto()) @map("_id") @db.ObjectId

  tutorId                 String                      @db.ObjectId
  tutor                   Tutor                       @relation(fields: [tutorId], references: [id])

  boardId                 String?                     @db.ObjectId
  subjectId               String                      @db.ObjectId
  levelId                 String                      @db.ObjectId
  languageId              String?                     @db.ObjectId


  title                   String
  seo_name                String                      @unique
  description             String

  syllabus                Json

  previewImg              String?
  previewVdo              String?

  type                    ClassType                   @default(GROUP)
  visibility              ClassVisibility             @default(PUBLIC)
  status                  ClassStatus                 @default(DRAFT)

  startDate               DateTime
  endDate                 DateTime
  
  joiningStartDate        DateTime
  joiningEndDate          DateTime

  daysOfWeek              DayOfWeek[]
  startTime               String?
  durationMin             Int?
  timeZone                String?

  capacity                Int                         @default(1)

  isPaid                  Boolean                     @default(false)
  price                   Float?
  currency                String?


  createdAt               DateTime                    @default(now())
  updatedAt               DateTime                    @updatedAt

  board                   Board?                      @relation(fields: [boardId], references: [id])
  subject                 Subject                     @relation(fields: [subjectId], references: [id])
  level                   Level                       @relation(fields: [levelId], references: [id])
  language                Language?                   @relation(fields: [languageId], references: [id])
  enrollments             ClassEnrollment[]
  sessions                Session[]

  @@index([tutorId])
  @@index([type, status])
}



model ClassEnrollment {
  id                String              @id @default(auto()) @map("_id") @db.ObjectId

  classId           String              @db.ObjectId
  studentId         String              @db.ObjectId

  enrolledAt        DateTime            @default(now())

  klass             TuitionClass        @relation(fields: [classId], references: [id])
  student           Student             @relation(fields: [studentId], references: [id])

  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  @@unique([classId, studentId])
}


enum SessionType{
  REGULAR
  EXTRA
  DOUBT
}

enum SessionStatus{
  PENDING_TUTOR_APPROVAL   // PRIVATE
  SCHEDULED
  CANCELLED_BY_TUTOR
  CANCELLED_BY_STUDENT
  NO_SHOW_STUDENT
  COMPLETED
}


model Session {
  id                      String           @id @default(auto()) @map("_id") @db.ObjectId

  classId                 String           @db.ObjectId
  tutorId                 String           @db.ObjectId
  studentId               String?          @db.ObjectId

  klass                   TuitionClass     @relation(fields: [classId], references: [id])
  attendances             Attendance[]

  date                    DateTime
  startTime               String
  durationMin             Int

  sessionType             SessionType
  status                  SessionStatus
  createdBy               String
  meetingLink             String?

  createdAt               DateTime            @default(now())
  updatedAt               DateTime            @updatedAt

  @@index([classId])
  @@index([tutorId])
  @@index([studentId])
  @@index([date])
}



enum AttendanceStatus{
  PRESENT
  ABSENT
  LEAVE
}

model Attendance{
  id                    String              @id @default(auto()) @map("_id") @db.ObjectId

  sessionId             String              @db.ObjectId
  session               Session             @relation(fields: [sessionId], references: [id])

  studentId             String              @db.ObjectId
  student               Student             @relation(fields: [studentId], references:[id])

  status                AttendanceStatus
  markedBy              String
  markedAt              DateTime            @default(now())

  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  @@unique([sessionId, studentId])
  @@index([studentId])
}


model TutorAvailability {
  id                    String          @id @default(auto()) @map("_id") @db.ObjectId

  tutorId               String          @db.ObjectId
 
  dayOfWeek             DayOfWeek
  startTime             String    // "09:00"
  endTime               String    // "12:00"
  timeZone              String

  isActive              Boolean         @default(true)

  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt

  @@index([tutorId, dayOfWeek])
}


model TutorTimeOff {
  id                String             @id @default(auto()) @map("_id") @db.ObjectId

  tutorId           String             @db.ObjectId

  date              DateTime  // 2025-02-10
  startTime         String    // "10:30"
  endTime           String    // "11:30"

  reason            String?
  createdAt         DateTime            @default(now())

  @@index([tutorId, date])
}


model TutorLeave {
  id                String              @id @default(auto()) @map("_id") @db.ObjectId

  tutorId           String              @db.ObjectId

  startDate         DateTime
  endDate           DateTime

  reason            String?
  createdAt         DateTime            @default(now())

  @@index([tutorId, startDate, endDate])
}
