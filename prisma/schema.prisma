generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}


enum Roles{
  STUDENT
  TUTOR
  ADMIN
}


enum AuthProvider {
  CREDENTIALS
  GOOGLE
  APPLE
}

model User {
  id                      String                    @id @default(auto()) @map("_id") @db.ObjectId
  name                    String?
  email                   String                    @unique
  phone                   String?                   @unique
  password                String?
  avatar                  String?
  role                    Roles                     @default(STUDENT)

  provider                AuthProvider              @default(CREDENTIALS)

  isEmailVerified         Boolean                   @default(false)
  isPhoneVerified         Boolean                   @default(false)

  hashedRefreshToken      String?
  refreshTokenExpiresAt   DateTime?

  student                 Student[]
  tutor                   Tutor[]


  createdAt               DateTime                  @default(now())
  updatedAt               DateTime                  @updatedAt
}

model Student{
  id                      String                    @id @default(auto()) @map("_id") @db.ObjectId

  user                    User                      @relation(fields: [userId], references: [id])
  userId                  String                    @unique @db.ObjectId

  classGrade              String?
  board                   String?
  stream                  String?

  createdAt               DateTime                  @default(now())
  updatedAt               DateTime                  @updatedAt
}

enum TutorStatus {
  NOT_APPLIED      // just signed up as tutor but hasn't filled form yet
  PENDING_REVIEW   // form submitted, waiting for admin
  APPROVED         // verified tutor
  REJECTED         // rejected, can re-apply
  SUSPENDED        // blocked by admin
}


model Tutor{
  id                      String                    @id @default(auto()) @map("_id") @db.ObjectId

  user                    User                      @relation(fields: [userId], references: [id])
  userId                  String                    @unique @db.ObjectId

  shortTitle              String?
  subjects                String[]
  levels                  String[]
  yearsOfExp              Int?
  bio                     String?
  qualification           String?
  links                   String[]
  isVerified              Boolean                   @default(false)
  tutorStatus             TutorStatus               @default(NOT_APPLIED)

  createdAt               DateTime                  @default(now())
  updatedAt               DateTime                  @updatedAt
  verificationRequests    TutorVerificationRequest[]
}


enum VerificationStatus {
  PENDING
  APPROVED
  REJECTED
}

model TutorVerificationRequest {
  id                          String                    @id @default(auto()) @map("_id") @db.ObjectId
  tutorId                     String                    @db.ObjectId
  tutor                       Tutor                     @relation(fields: [tutorId], references: [id])
  status                      VerificationStatus        @default(PENDING)
  adminId                     String?                   @db.ObjectId
  adminNote                   String?
  documents                   String[]
  createdAt                   DateTime                  @default(now())
  updatedAt                   DateTime                  @updatedAt
}


enum Status {
  ACTIVE
  INACTIVE
  ARCHIVED
}


model Subject{
  id                      String                    @id @default(auto()) @map("_id") @db.ObjectId

  name                    String
  slug                    String                    @unique
  icon                    String?
  priority                Int                       @unique
  status                  Status                    @default(ACTIVE)

  createdAt               DateTime                  @default(now())
  updatedAt               DateTime                  @updatedAt

  @@index([status])
}


model Level{
  id                      String                    @id @default(auto()) @map("_id") @db.ObjectId

  name                    String
  slug                    String                    @unique
  icon                    String?
  priority                Int                       @unique
  status                  Status                    @default(ACTIVE)

  createdAt               DateTime                  @default(now())
  updatedAt               DateTime                  @updatedAt

  @@index([status])
}


model Board{
  id                      String                    @id @default(auto()) @map("_id") @db.ObjectId

  name                    String
  slug                    String                    @unique
  icon                    String?
  priority                Int                       @unique
  status                  Status                    @default(ACTIVE)

  createdAt               DateTime                  @default(now())
  updatedAt               DateTime                  @updatedAt

  @@index([status])
}


model Language{
  id                      String                    @id @default(auto()) @map("_id") @db.ObjectId

  name                    String
  slug                    String                    @unique
  icon                    String?
  priority                Int                       @unique
  status                  Status                    @default(ACTIVE)

  createdAt               DateTime                  @default(now())
  updatedAt               DateTime                  @updatedAt

  @@index([status])
}




//Task System
enum TaskType{
  PRIVATE
  ASSIGNED
}

enum TaskStatus{
  TODO
  ONGOING
  COMPLETED
}

enum TaskCommentType{
  HELP_REQUEST
  TUTOR_REPLY
  TUTOR_REMARK
  TUTOR_FEEDBACK
}

model ClassTask {
  id                      String                    @id @default(auto()) @map("_id") @db.ObjectId

  classId                 String                    @db.ObjectId
  tutorId                 String                    @db.ObjectId

  title                   String
  description             String?
  
  dueDate                 DateTime?

  createdAt               DateTime                  @default(now())
  updatedAt               DateTime                  @updatedAt

  tasks                   Task[]                    @relation("ClassTaskToStudentTasks")

  @@index([classId])
  @@index([tutorId])
}


model Task{
  id                      String                    @id @default(auto()) @map("_id") @db.ObjectId

  studentId               String                    @db.ObjectId

  title                   String
  description             String?

  dueDate                 DateTime?

  type                    TaskType                  @default(PRIVATE)
  status                  TaskStatus                @default(TODO)

  // Only for CLASS_ASSIGNED tasks
  classTaskId             String?                   @db.ObjectId
  classTask               ClassTask?                @relation("ClassTaskToStudentTasks",fields: [classTaskId],references: [id])

  classId                 String?                   @db.ObjectId
  tutorId                 String?                   @db.ObjectId

  // Indicates tutor override (rejected proof)
  overriddenByTutor       Boolean                   @default(false)

  createdAt               DateTime                  @default(now())
  updatedAt               DateTime                  @updatedAt

  proofs                  TaskProof[]
  comments                TaskComment[]

  @@index([studentId])
  @@index([classTaskId])
  @@index([classId])
  @@index([tutorId])
  @@index([status])
  @@index([type])
  @@index([studentId, status]) // dashboard filters
}


model TaskProof {
  id                      String                      @id @default(auto()) @map("_id") @db.ObjectId

  taskId                  String                      @db.ObjectId
  task                    Task                        @relation(fields: [taskId], references: [id])

  studentId               String                      @db.ObjectId

  fileUrl                 String
  note                    String?

  createdAt               DateTime                    @default(now())

  @@index([taskId])
}


model TaskComment {
  id                      String                      @id @default(auto()) @map("_id") @db.ObjectId

  taskId                  String                      @db.ObjectId
  task                    Task                        @relation(fields: [taskId], references: [id])

  authorId                String                      @db.ObjectId

  type                    TaskCommentType
  message                 String

  createdAt               DateTime                    @default(now())

  @@index([taskId])
  @@index([type])
}

